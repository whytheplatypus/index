<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <script>
            function template(t, ...args) {
                return new Function(args, "return `"+t+"`" );
            }

customElements.define('a-distraction', 
            class extends HTMLElement {

                static get observedAttributes() {
                    return ['data-title', 'href'];
                }

                set href(val) {
                    this.querySelector("article").textContent = val
                }

                constructor() {
                    super();
                }

                connectedCallback() {
                    let template = document.getElementById("article");
                    let templateContent = template.content;
                    this.appendChild(templateContent.cloneNode(true))
                    this.querySelector("h1").textContent = "test"
                }

                async loadMetadata(url, article) {
                    var domParser = new DOMParser()
                    let response = await fetch("https://cors-anywhere.herokuapp.com/"+url, {
                        mode: "cors",
                        redirect: "error",
                    })
                    let article_html = await response.text()
                    let article_dom = domParser.parseFromString(article_html, 'text/html')

                    let desc = document.createElement('h2')
                    desc.textContent = article_dom.querySelector("meta[property='og:description'").getAttribute("content")
                    article.appendChild(desc)

                    let img = document.createElement('img');
                    img.src = article_dom.querySelector("meta[property='og:image'").getAttribute("content")
                    article.appendChild(img)
                }

                attributeChangedCallback(name, oldValue, newValue) {
                    console.debug(arguments)
                    this[name] = newValue
                }
            })

customElements.define('some-distractions', 
            class extends HTMLElement {
                constructor() {
                    super();

                    console.log(this.attributes.from)
                    /*
                    let template = document.getElementById("distractions");
                    let templateContent = template.content;
                    const shadowRoot = this.attachShadow({mode: 'open'});
                    shadowRoot.appendChild(templateContent.cloneNode(true));
                    */
                }


                async loadArticles(url) {
                    let publication = "https://cors-anywhere.herokuapp.com/"+url 
                    let response = await fetch(publication, {mode: "cors"})
                    let txt = await response.text()
                    var domParser = new DOMParser()
                    // self.textContent = txt
                    let doc = domParser.parseFromString(txt, 'text/xml')
                    let items = doc.querySelectorAll('item')
                    return Array.from(items).map(function(item) {
                        return {
                            "uri": item.querySelector("link").textContent,
                            "title": item.querySelector("title").textContent,
                        };
                    })
                }

                connectedCallback() {
                    this.renderArticles(this.getAttribute("from"))
                }

                async renderArticles(url) {
                    let article_template = this.querySelector("template[slot='article']")
                    let article = article_template.innerHTML
                    let format = template(article, "title", "uri")
                    let items = await this.loadArticles(url)
                    for (let item of items) {
                        let d = document.createElement('div')
                        d.innerHTML = format(item.title, item.uri)
                        this.appendChild(d)
                    }
                }
            })

        </script>
        <style>
        </style>
    </head>
    <body>
        <main>
            <section>
                <some-distractions from="https://news.ycombinator.com/rss">
                    <h1>Hacker News</h1>
                    <template slot="article">
                        <article>
                            <h1><a href="${uri}" target="_blank">${title}</a></h1>
                            <img data-src="img"></img>
                            <p data-content="description"></p>
                        </article>
                    </template>
                </some-distractions>
            </section>
        </main>
    </body>
</html>
