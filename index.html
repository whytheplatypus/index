<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
		<link rel="stylesheet" type="text/css" href="https://unpkg.com/augmented-ui/augmented.css">
        <script>
            function template(t, ...args) {
                return new Function(args, "return `"+t+"`" );
            }

customElements.define('a-distraction', 
            class extends HTMLElement {

                static get observedAttributes() {
                    return ['title', 'uri', 'img', 'description'];
                }

                constructor() {
                    super();
                }

                connectedCallback() {
                    let article = this.innerHTML
                    this.format = template(article, ...this.constructor.observedAttributes)
					this.loadMetadata(this.getAttribute('uri'))
					this.render()
                }

				render() {
					if (this.format) {
                    	this.innerHTML = this.format(...this.getAttributes())
					}
				}

				getAttributes() {
					let attrs = []
					for (let attr of this.constructor.observedAttributes) {
						attrs.push(this.getAttribute(attr))
					}
					return attrs
				}

                async loadMetadata(url) {
                    var domParser = new DOMParser()
                    let response = await fetch("https://cors-anywhere.herokuapp.com/"+url, {
                        mode: "cors",
                        redirect: "error",
                    })
                    let article_html = await response.text()
                    let article_dom = domParser.parseFromString(article_html, 'text/html')

                    this.setAttribute("description", article_dom.querySelector("meta[property='og:description'").getAttribute("content"))
                    this.setAttribute("img", article_dom.querySelector("meta[property='og:image'").getAttribute("content"))
                }

                attributeChangedCallback(name, oldValue, newValue) {
					this.render()
                }
            })

customElements.define('some-distractions', 
            class extends HTMLElement {
                constructor() {
                    super();
                }


                async loadArticles(url) {
                    let publication = "https://cors-anywhere.herokuapp.com/"+url 
                    let response = await fetch(publication, {mode: "cors"})
                    let txt = await response.text()
                    var domParser = new DOMParser()
                    // self.textContent = txt
                    let doc = domParser.parseFromString(txt, 'text/xml')
                    let items = doc.querySelectorAll('item')
                    return Array.from(items).map(function(item) {
                        return {
                            "uri": item.querySelector("link").textContent,
                            "title": item.querySelector("title").textContent,
                        };
                    })
                }

                connectedCallback() {
                    this.renderArticles(this.getAttribute("from"))
                }

                async renderArticles(url) {
                    let article_template = this.querySelector("template[slot='article']")
                    let articleContent = article_template.content
                    let items = await this.loadArticles(url)
                    for (let item of items) {
						let articleNode = articleContent.cloneNode(true)
						let article = articleNode.querySelector("a-distraction[data-src='item']")
						for (let attr in item) {
							article.setAttribute(attr, item[attr])
						}
                        this.append(articleNode)
                    }
                }
            })

        </script>
        <style>
			body {
				background: #100c0c;
			}
			html, body, section, main {
				height: 100%;
			}
			.demo {
				margin: 10px;
				--aug-border: 5px;
				--aug-inset: 5px;
				padding: 20px; /* mind the gap */
				--aug-border-bg: #2D778A;
				--aug-inset-bg: #2D778A;
				--aug-b-width: 80%;
				--aug-b-height: 7px;
				--aug-tl-width: 10%;
				--aug-tl-height: 7px;
				--aug-tr-height: 7px;
				--aug-tr-width: 10%;
			}
			h1.demo {
				text-align: center;
			}
			header {
				display: flex;
				align-items: center;
  				justify-content: center;
			}
			section {
				float: left;
				width: 50%;
				min-width: 345px;
				overflow: scroll;
				scrollbar-width: none;
			}
			some-distractions {
				display: block;
			}
			article {
				display: flex;
				flex-flow: row wrap;
				align-items: center;
  				justify-content: center;
			}
			article > * {
				padding: 10px;
			}
			.demo a {
				color: black;
			}
			article > img{
				flex: 0 0 256px;
			}
			.box {
				flex: 1 1 auto;
				display: flex;
				flex-direction: column;
				align-items: center;
  				justify-content: center;
			}
        </style>
    </head>
    <body>
        <main>
            <section>
                <some-distractions from="https://news.ycombinator.com/rss">
					<header class="demo" augmented-ui="tl-clip-x tr-clip-x br-clip bl-clip b-clip-x exe">
                    	<h1>Hacker News</h1>
					</header>
                    <template slot="article">
						<a-distraction data-src="item" >
							<article class="demo" augmented-ui="tl-clip-x tr-clip-x br-clip bl-clip b-clip-x exe">
								<img style="${(!img)?'display:none':''}" src="${img}"></img>
								<div class="box">
									<h1><a href="${uri}" target="_blank">${title}</a></h1>
									<p>${(description)?description:""}</p>
								</div>
							</article>
						</a-distraction>
                    </template>
                </some-distractions>
			</section>
            <section>
				<some-distractions from="https://www.npr.org/rss/rss.php?id=1001">
					<header class="demo" augmented-ui="tl-clip-x tr-clip-x br-clip bl-clip b-clip-x exe">
                    	<h1>NPR News</h1>
					</header>
                    <template slot="article">
						<a-distraction data-src="item" >
							<article class="demo" augmented-ui="tl-clip-x tr-clip-x br-clip bl-clip b-clip-x exe">
								<img style="${(!img)?'display:none':''}" src="${img}"></img>
								<div class="box">
									<h1><a href="${uri}" target="_blank">${title}</a></h1>
									<p>${(description)?description:""}</p>
								</div>
							</article>
						</a-distraction>
                    </template>
				</some-distractions>
            </section>
        </main>
    </body>
</html>
